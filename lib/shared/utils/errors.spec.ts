/* eslint-disable max-len */
import { getTenderlyUrlFromErrorMessage } from './errors'

describe('getTenderlyUrlFromError', () => {
  const queryMeta = { context: { extra: { params: { chainId: 100, blockNumber: 36029196n } } } }

  test('when queryMeta does not have chainId', () => {
    const queryMeta = { context: { extra: { params: {} } } }
    const error = new Error('Random error')
    expect(getTenderlyUrlFromErrorMessage(error, queryMeta)).toBeUndefined()
  })

  test('when error is not "RPC Request failed"', () => {
    const error = new Error('Random error')
    expect(getTenderlyUrlFromErrorMessage(error, queryMeta)).toBeUndefined()
  })

  test('when error is an "RPC Request failed"', () => {
    // Typical message from a ContractFunctionExecutionError from viem
    const errorMessage = `RPC Request failed.

  URL: http://localhost:3000/api/rpc/GNOSIS
  Request body: {"method":"eth_call","params":[{"data":"0xc7b2c52c4d7d7b769cc617a00ed98ff3426c350a50e727120001000000000000000000c1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050000000000000000000000002a22f9c3b484c3629090feed35f17ff8f88f76f00000000000000000000000004ecaba5870353805a9f068101a40e0f32ed605c60000000000000000000000007ef541e2a22058048904fe5744f9c7e4c57af7170000000000000000000000008fed19c7e7b59e7cfe8d0a1f570c96a721198710000000000000000000000000af204776c7245bf4147c2612bf6e5972ee4837010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000016954c3922357c2d1710000000000000000000000000000000000000000000000000000000000000000","to":"0x0f3e0c4218b7b0108a3643cfe9d3ec0d4f57c54e"},"latest"]}

  Raw Call Arguments:
    to:    0x0f3e0c4218b7b0108a3643cfe9d3ec0d4f57c54e
    data:  0xc7b2c52c4d7d7b769cc617a00ed98ff3426c350a50e727120001000000000000000000c1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050000000000000000000000002a22f9c3b484c3629090feed35f17ff8f88f76f00000000000000000000000004ecaba5870353805a9f068101a40e0f32ed605c60000000000000000000000007ef541e2a22058048904fe5744f9c7e4c57af7170000000000000000000000008fed19c7e7b59e7cfe8d0a1f570c96a721198710000000000000000000000000af204776c7245bf4147c2612bf6e5972ee4837010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000016954c3922357c2d1710000000000000000000000000000000000000000000000000000000000000000

  Contract Call:
    address:   0x0f3e0c4218b7b0108a3643cfe9d3ec0d4f57c54e
    function:  queryExit(bytes32 poolId, address sender, address recipient, (address[] assets, uint256[] minAmountsOut, bytes userData, bool toInternalBalance))
    args:               (0x4d7d7b769cc617a00ed98ff3426c350a50e727120001000000000000000000c1, 0x0000000000000000000000000000000000000000, 0x0000000000000000000000000000000000000000, {"assets":["0x2a22f9c3b484c3629090feed35f17ff8f88f76f0","0x4ecaba5870353805a9f068101a40e0f32ed605c6","0x7ef541e2a22058048904fe5744f9c7e4c57af717","0x8fed19c7e7b59e7cfe8d0a1f570c96a721198710","0xaf204776c7245bf4147c2612bf6e5972ee483701"],"minAmountsOut":["1","1","1","1","1"],"userData":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000016954c3922357c2d1710000000000000000000000000000000000000000000000000000000000000000","toInternalBalance":false})

  Docs: https://viem.sh/docs/contract/simulateContract
  Details: vm execution error.
  Version: 2.21.6
      at getContractError (webpack-internal:///(app-pages-browser)/./node_modules/.pnpm/viem@2.21.6_bufferutil@4.0.8_typescript@5.4.5_utf-8-validate@5.0.10_zod@3.22.4/node_modules/viem/_esm/utils/errors/getContractError.js:34:12)
      at simulateContract (webpack-internal:///(app-pages-browser)/./node_modules/.pnpm/viem@2.21.6_bufferutil@4.0.8_typescript@5.4.5_utf-8-validate@5.0.10_zod@3.22.4/node_modules/viem/_esm/actions/public/simulateContract.js:83:98)
      at async doRemoveLiquidityQuery (webpack-internal:///(app-pages-browser)/./node_modules/.pnpm/@balancer+sdk@0.25.0_bufferutil@4.0.8_typescript@5.4.5_utf-8-validate@5.0.10_zod@3.22.4/node_modules/@balancer/sdk/dist/index.mjs:17702:7)
      at async RemoveLiquidityWeighted.query (webpack-internal:///(app-pages-browser)/./node_modules/.pnpm/@balancer+sdk@0.25.0_bufferutil@4.0.8_typescript@5.4.5_utf-8-validate@5.0.10_zod@3.22.4/node_modules/@balancer/sdk/dist/index.mjs:17732:25)
      at async SingleTokenRemoveLiquidityHandler.simulate (webpack-internal:///(app-pages-browser)/./lib/modules/pool/actions/remove-liquidity/handlers/SingleTokenRemoveLiquidity.handler.ts:22:32)
    `
    const error = new Error(errorMessage)

    expect(getTenderlyUrlFromErrorMessage(error, queryMeta)).toBe(
      'https://dashboard.tenderly.co/balancer/v2/simulator/new?rawFunctionInput=0xc7b2c52c4d7d7b769cc617a00ed98ff3426c350a50e727120001000000000000000000c1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050000000000000000000000002a22f9c3b484c3629090feed35f17ff8f88f76f00000000000000000000000004ecaba5870353805a9f068101a40e0f32ed605c60000000000000000000000007ef541e2a22058048904fe5744f9c7e4c57af7170000000000000000000000008fed19c7e7b59e7cfe8d0a1f570c96a721198710000000000000000000000000af204776c7245bf4147c2612bf6e5972ee4837010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000016954c3922357c2d1710000000000000000000000000000000000000000000000000000000000000000&block=36029196&blockIndex=0&from=0x0000000000000000000000000000000000000000&gas=8000000&gasPrice=0&value=0&contractAddress=0x0f3e0c4218b7b0108a3643cfe9d3ec0d4f57c54e&network=100'
    )
  })
})
